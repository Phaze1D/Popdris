function resize(){var t=document.getElementById("container");ratio=Math.min(t.clientWidth/GAME_WIDTH,t.clientHeight/GAME_HEIGHT),APP.stage.scale.x=APP.stage.scale.y=ratio,APP.renderer.resize(Math.ceil(GAME_WIDTH*ratio),Math.ceil(GAME_HEIGHT*ratio))}function distance(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(Math.pow(i,2)+Math.pow(n,2))}function angle(t,e){var i=e.x-t.x,n=e.y-t.y,a=Math.atan2(n,i);return a*=180/Math.PI,a<0&&(a=360+a),a}function getDirection(t){return t>=315&&t<360||t<45&&t>=0?RIGHT:t>=45&&t<135?DOWN:t>=135&&t<225?LEFT:UP}function init(){document.getElementById("spinner").style.display="none",document.getElementById("container").appendChild(APP.view),resize(),createStartScene()}function createStartScene(){if(APP.stage.children.length>0){APP.stage.removeChildAt(0).destroy({children:!0})}var t=new StartScene(createPlayScene);t.startBackground(),APP.stage.addChild(t)}function createPlayScene(){APP.stage.removeChildAt(0).destroy({children:!0});var t=new PlayScene(createStartScene);t.startGame(),APP.stage.addChild(t)}var MLoader=function(t){if("function"!=typeof t)throw new TypeError("onHelpTap is not a function");this.onRequestLoad=t};MLoader.prototype.loadAssets=function(){window.WebFontConfig={google:FONTS,active:function(){PIXI.loader.add(RESOURCES).load(this.onRequestLoad)}.bind(this)}};var resources=PIXI.loader.resources,Container=PIXI.Container,Sprite=PIXI.Sprite,Text=PIXI.Text,Graphics=PIXI.Graphics;const GAME_WIDTH=450,GAME_HEIGHT=700,UP=1,DOWN=-1,LEFT=-2,RIGHT=2,FONTS={families:["Varela+Round","Fredoka+One"]},RESOURCES=[{name:"bubbles",url:"assets/bubbles_atlas/bubbles.json"},{name:"ui",url:"assets/ui_atlas/ui.json"}];window.addEventListener("resize",resize);var Bubble=function(t){PIXI.Sprite.call(this,resources.bubbles.textures[t]),this.color=t,this.width=Bubble.DIAMETER,this.height=Bubble.DIAMETER,this.finaly=GAME_HEIGHT+Bubble.DIAMETER,this.finalx=0,this.interactive=!0,this.dragData={dragging:!1,x:1,y:2},this.falling=!0,this.velocity=null,this.switchDirection=null,this.switching=!1,this.onRequestDragEnd=null,this.onRequestClick=null,this.checked=!1,this.on("pointerdown",this.onDragStart).on("pointerup",this.onDragEnd).on("pointerupoutside",this.onDragEnd)};Bubble.prototype=Object.create(PIXI.Sprite.prototype),Bubble.prototype.constructor=Bubble,Bubble.prototype.fall=function(){this.y+this.velocity<this.finaly?(this.y+=this.velocity,this.falling=!0):(this.velocity=6,this.y=this.finaly,this.falling=!1,this.y==GamePlay.HEIGHT-GamePlay.TOTAL_BUBBLE_DIA*(GamePlay.NUM_BUBBLES-1)-GamePlay.TOTAL_BUBBLE_DIA&&this.onRequestLost())},Bubble.prototype.switchAnimation=function(){switch(this.switchDirection){case UP:this.y=this.y>this.finaly?this.y-this.velocity:this.finaly,this.switching=this.y!=this.finaly;break;case DOWN:this.y=this.y<this.finaly?this.y+this.velocity:this.finaly,this.switching=this.y!=this.finaly;break;case LEFT:this.x=this.x>this.finalx?this.x-this.velocity:this.finalx,this.switching=this.x!=this.finalx;break;case RIGHT:this.x=this.x<this.finalx?this.x+this.velocity:this.finalx,this.switching=this.x!=this.finalx}},Bubble.prototype.onDragStart=function(t){if(!this.switching){this.dragData.dragging=!0;var e=t.data.getLocalPosition(this.parent);this.dragData.x=e.x,this.dragData.y=e.y}},Bubble.prototype.onDragEnd=function(t){if(this.dragData.dragging){var e=t.data.getLocalPosition(this.parent);if(this.dragData.dragging=!1,distance(this.dragData,e)>Bubble.DIAMETER/4){var i=getDirection(angle(this.dragData,e));this.onRequestDragEnd(this.column,this.row,i)}else this.onRequestClick(this.column,this.row,this.color)}},Bubble.COLORS=["blue","green","grey","yellow","red","purple"],Bubble.DIAMETER=40,Bubble.MARGIN=2;var BubbleSpawner=function(t,e,i){if("function"!=typeof t)throw new TypeError("difficultyVsTimeFunc is not a function");Container.call(this),this.dropRate=.5,this.totalTime=0,this.timer=0,this.gwidth=e,this.gheight=i,this.difficulty=t};BubbleSpawner.prototype=Object.create(Container.prototype),BubbleSpawner.prototype.constructor=BubbleSpawner,BubbleSpawner.prototype.update=function(t){var e=void 0;return this.timer/1e3>=1/this.dropRate&&(e=this.spawnBubble()),this.updateBubbles(t),this.totalTime+=APP.ticker.elapsedMS,this.timer+=APP.ticker.elapsedMS,e},BubbleSpawner.prototype.updateBubbles=function(t){for(var e=0;e<this.children.length;e++)t||(this.children[e].checked=!1),this.children[e].switching?this.children[e].switchAnimation():this.children[e].fall()},BubbleSpawner.prototype.spawnBubble=function(){var t=this.difficulty(this.totalTime);this.dropRate=t.dropRate;var e=this.createRandomBubble();if(e.velocity=t.speed,this.addChild(e),this.timer=0,this.getChildAt(0).y>this.gheight){this.removeChildAt(0).destroy({children:!0})}return e},BubbleSpawner.prototype.createRandomBubble=function(){var t=Math.floor(Math.random()*Bubble.COLORS.length),e=Bubble.COLORS[t];return this.createBubble(e)},BubbleSpawner.prototype.createBubble=function(t){var e=new Bubble(t),i=(this.gwidth-Bubble.MARGIN)/(Bubble.DIAMETER+Bubble.MARGIN),n=Math.floor(i);this.numOfColumns=n;var a=(i-n)*Bubble.DIAMETER/(n+1),o=Math.floor(Math.random()*n);return e.column=o,e.x=(Bubble.MARGIN+Bubble.DIAMETER+a)*o+Bubble.MARGIN+a,e.y=-e.height,e};var Button=function(t,e,i,n){Sprite.call(this,resources.ui.textures[e]),this.interactive=!0,this.buttonMode=!0,this.normalSprite=e,this.pressedSprite=i,this.anchor.set(.5);var a=new Text(t,n);a.anchor.set(.5),this.addChild(a)};Button.prototype=Object.create(Sprite.prototype),Button.prototype.constructor=Button,Button.labelButtonFactory=function(t,e,i,n){var a=new Button(t,e,i,n);return a.height=64,a.width=256,a.on("pointerdown",function(){this.texture=resources.ui.textures[this.pressedSprite]}),a.on("pointerup",function(){this.texture=resources.ui.textures[this.normalSprite],this.onTap()}),a.on("pointerupoutside",function(){this.texture=resources.ui.textures[this.normalSprite]}),a},Button.RAISE_STYLE={fontWeight:"bold",fontSize:60,fontFamily:"Varela Round",fill:"#fafafa"},Button.FLAT_STYLE={fontWeight:"bold",fontSize:60,fontFamily:"Varela Round",fill:"#ff5722"};var GamePlay=function(){Container.call(this),this.__initMask(),this.__initSpawner(),this.__initBorder(),this.bubbleGrid=new Array(this.spawner.numOfColumns),this.checkingPop=!1,this.onUpdateScore=null};GamePlay.prototype=Object.create(Container.prototype),GamePlay.prototype.constructor=GamePlay,GamePlay.prototype.__initBorder=function(){var t=new Graphics;t.lineStyle(2,16733986,1),t.beginFill(16733986,.1),t.drawRoundedRect(GamePlay.X,GamePlay.Y,GamePlay.WIDTH,GamePlay.HEIGHT,5),t.endFill(),this.addChild(t)},GamePlay.prototype.__initMask=function(){var t=new Graphics;t.beginFill(16777215,.25),t.drawRect(GamePlay.X-2,GamePlay.Y-2,GamePlay.WIDTH+4,GamePlay.HEIGHT+4),t.endFill(),this.mask=t},GamePlay.prototype.__initSpawner=function(){this.spawner=new BubbleSpawner(GamePlay.difficultyEquation,GamePlay.WIDTH,GamePlay.HEIGHT),this.spawner.x=GamePlay.X,this.spawner.y=GamePlay.Y,this.addChild(this.spawner)},GamePlay.prototype.update=function(){var t=this.spawner.update(this.checkingPop);t&&this.addBubble(t)},GamePlay.prototype.addBubble=function(t){this.bubbleGrid[t.column]||(this.bubbleGrid[t.column]=[]),this.bubbleGrid[t.column].push(t),t.row=this.bubbleGrid[t.column].length-1,t.onRequestLost=this.onRequestLost,t.finaly=GamePlay.HEIGHT-GamePlay.TOTAL_BUBBLE_DIA*t.row-GamePlay.TOTAL_BUBBLE_DIA,t.onRequestDragEnd=this.onBubbleDragEnd.bind(this),t.onRequestClick=this.onBubbleClick.bind(this)},GamePlay.prototype.getBubble=function(t,e){return e>=0&&t>=0&&t<this.spawner.numOfColumns&&this.bubbleGrid[t]&&this.bubbleGrid[t][e]},GamePlay.prototype.onBubbleClick=function(t,e,i){var n={columns:{},toRemove:[]};this.checkingPop=!0,this.popAlgorithm(t,e,i,n),this.checkingPop=!1,n.toRemove.length>=3&&(this.removeBubbles(n.toRemove),this.adjustBubbles(n.columns),this.onUpdateScore(GamePlay.pointsEquation(n.toRemove.length)))},GamePlay.prototype.popAlgorithm=function(t,e,i,n){var a=this.getBubble(t,e);!a||a.color!==i||a.falling||a.switching||a.checked||(a.checked=!0,n.toRemove.push(a),n.columns[t]||(n.columns[t]={startAt:e}),n.columns[t].startAt>e&&(n.columns[t].startAt=e),this.popAlgorithm(t,e+1,i,n),this.popAlgorithm(t,e-1,i,n),this.popAlgorithm(t-1,e,i,n),this.popAlgorithm(t+1,e,i,n))},GamePlay.prototype.removeBubbles=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.bubbleGrid[i.column][i.row]=void 0,i.destroy()}},GamePlay.prototype.adjustBubbles=function(t){for(var e in t)if(t.hasOwnProperty(e)){for(var i=0,n=t[e].startAt;n<this.bubbleGrid[e].length;n++){var a=this.getBubble(e,n);a?(a.row-=i,this.bubbleGrid[e][a.row]=a,a.finaly=GamePlay.HEIGHT-GamePlay.TOTAL_BUBBLE_DIA*a.row-GamePlay.TOTAL_BUBBLE_DIA):i++}this.bubbleGrid[e].length-=i}},GamePlay.prototype.onBubbleDragEnd=function(t,e,i){switch(i){case UP:this.switchBubbles({r:e,c:t},{r:e+1,c:t},i,"y");break;case DOWN:this.switchBubbles({r:e,c:t},{r:e-1,c:t},i,"y");break;case LEFT:this.switchBubbles({r:e,c:t},{r:e,c:t-1},i,"x");break;case RIGHT:this.switchBubbles({r:e,c:t},{r:e,c:t+1},i,"x")}},GamePlay.prototype.switchBubbles=function(t,e,i,n){var a=this.getBubble(e.c,e.r);if(a&&!a.falling&&!a.switching){var o=this.bubbleGrid[t.c][t.r];this.bubbleGrid[e.c][e.r]=o,this.bubbleGrid[t.c][t.r]=a,o.column=e.c,o.row=e.r,a.column=t.c,a.row=t.r,o["final"+n]=a[n],a["final"+n]=o[n],o.switching=!0,a.switching=!0,o.switchDirection=i,a.switchDirection=-1*i}},GamePlay.prototype.reset=function(){this.spawner.removeChildren();for(var t=0;t<this.bubbleGrid.length;t++)for(var e=0;e<this.bubbleGrid[t].length;e++)this.bubbleGrid[t][e].destroy();this.bubbleGrid=new Array(this.spawner.numOfColumns),this.spawner.totalTime=0,this.spawner.timer=0},GamePlay.difficultyEquation=function(t){return{dropRate:(Math.log2(t)+t/1e3+10)/50,speed:Math.log2(t)/4+t/1e5}},GamePlay.pointsEquation=function(t){return Math.pow(t,2)},GamePlay.WIDTH=380,GamePlay.HEIGHT=650,GamePlay.X=2,GamePlay.Y=GAME_HEIGHT-GamePlay.HEIGHT-2,GamePlay.TOTAL_FIT=(GamePlay.HEIGHT-Bubble.MARGIN)/(Bubble.DIAMETER+Bubble.MARGIN),GamePlay.NUM_BUBBLES=Math.floor(GamePlay.TOTAL_FIT),GamePlay.EXTRA_MARGIN=(GamePlay.TOTAL_FIT-GamePlay.NUM_BUBBLES)*Bubble.DIAMETER/(GamePlay.NUM_BUBBLES+1),GamePlay.TOTAL_BUBBLE_DIA=Bubble.DIAMETER+GamePlay.EXTRA_MARGIN+Bubble.MARGIN;var PauseSection=function(t,e){Container.call(this),this.__initOverlay(),this.__initBorder(),this.__initResetButton(),this.__initQuitButton(),this.resetButton.onTap=t,this.quitButton.onTap=e,this.interactive=!0,this.on("click",function(t){t.stopPropagation()})};PauseSection.prototype=Object.create(Container.prototype),PauseSection.prototype.constructor=PauseSection,PauseSection.prototype.__initOverlay=function(){var t=new Graphics;t.lineStyle(2,0,.3),t.beginFill(0,.3),t.drawRoundedRect(GamePlay.X,GamePlay.Y,GamePlay.WIDTH,GamePlay.HEIGHT,5),t.endFill(),this.addChild(t)},PauseSection.prototype.__initBorder=function(){var t=new Graphics;t.lineStyle(2,2718207,1),t.beginFill(16777215,1),t.drawRoundedRect(GamePlay.X+GamePlay.WIDTH/2,GamePlay.Y+GamePlay.HEIGHT/2,PauseSection.WIDTH,PauseSection.HEIGHT,5),t.pivot.x=PauseSection.WIDTH/2,t.pivot.y=PauseSection.HEIGHT/2,t.endFill(),this.addChild(t)},PauseSection.prototype.__initResetButton=function(){this.resetButton=Button.labelButtonFactory("RESET","button_raised","button_flat",Button.RAISE_STYLE),this.resetButton.x=GamePlay.X+GamePlay.WIDTH/2,this.resetButton.y=GamePlay.Y+GamePlay.HEIGHT/2-60,this.addChild(this.resetButton)},PauseSection.prototype.__initQuitButton=function(){this.quitButton=Button.labelButtonFactory("QUIT","button_flatm","button_flatp",Button.FLAT_STYLE),this.quitButton.x=GamePlay.X+GamePlay.WIDTH/2,this.quitButton.y=GamePlay.Y+GamePlay.HEIGHT/2+60,this.addChild(this.quitButton)},PauseSection.WIDTH=300,PauseSection.HEIGHT=250;var StartScene=function(t){if("function"!=typeof t)throw new TypeError("onPlayTap is not a function");Container.call(this),this.__initSpawner(),this.__initPlayButton(),this.__initTitle(),this.playButton.onTap=t};StartScene.prototype=Object.create(Container.prototype),StartScene.prototype.constructor=StartScene,StartScene.prototype.__initSpawner=function(){this.bubbleGen=new BubbleSpawner(StartScene.difficultyEquation,GAME_WIDTH,GAME_HEIGHT),this.addChild(this.bubbleGen)},StartScene.prototype.__initPlayButton=function(){this.playButton=Button.labelButtonFactory("PLAY","button_raised","button_flat",Button.RAISE_STYLE),this.playButton.x=GAME_WIDTH/2,this.playButton.y=GAME_HEIGHT/2,this.addChild(this.playButton)},StartScene.prototype.__initTitle=function(){var t=new Text("Popdris",{fontWeight:"bold",fontSize:60,fontFamily:"Varela Round",fill:"#2979FF"});t.anchor.set(.5),t.x=GAME_WIDTH/2,t.y=100,this.addChild(t)},StartScene.prototype.startBackground=function(){APP.ticker.add(this.bubbleGen.update.bind(this.bubbleGen))},StartScene.difficultyEquation=function(t){return{dropRate:2,speed:4}};var PlayScene=function(t){if("function"!=typeof t)throw new TypeError("onRequestQuit is not a function");Container.call(this),this.__initGamePlay(),this.__initScore(),this.__initPauseSection(),this.onRequestQuit=t,this.lost=!1};PlayScene.prototype=Object.create(Container.prototype),PlayScene.prototype.constructor=PlayScene,PlayScene.prototype.__initGamePlay=function(){this.gamePlay=new GamePlay,this.gamePlay.onUpdateScore=this.updateScore.bind(this),this.gamePlay.onRequestLost=this.onGameLost.bind(this),this.addChild(this.gamePlay)},PlayScene.prototype.__initScore=function(){this.score=0,this.scoreLabel=new Text(this.score,{fontWeight:"bold",fontSize:40,fontFamily:"Varela Round",fill:"#2979FF"}),this.addChild(this.scoreLabel)},PlayScene.prototype.__initPauseSection=function(){this.pauseSection=new PauseSection(this.onGameReset.bind(this),this.onGameQuit.bind(this))},PlayScene.prototype.startGame=function(){APP.ticker.add(function(){this.lost||this.gamePlay.update()}.bind(this))},PlayScene.prototype.updateScore=function(t){this.score+=t,this.scoreLabel.text=this.score},PlayScene.prototype.onGameLost=function(){this.lost=!0,this.addChild(this.pauseSection)},PlayScene.prototype.onGameQuit=function(){this.onRequestQuit()},PlayScene.prototype.onGameReset=function(){this.removeChild(this.pauseSection),this.gamePlay.reset(),this.lost=!1,this.score=0,this.scoreLabel.text=this.score};const APP=new PIXI.Application(GAME_WIDTH,GAME_HEIGHT,{antialiasing:!0,transparent:!0,resolution:window.devicePixelRatio,autoResize:!0}),M_LOADER=new MLoader(init);M_LOADER.loadAssets();
